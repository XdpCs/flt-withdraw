<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
<h1 id="header">Connect to Wallet</h1>
<button class="connect"> Connect</button>
<h2>Wallet Address: <span class="showAccount"></span></h2>
<h2>Flt Balance: <span class="showFltBalance"></span></h2>
<h2>Lock Time (Based on the browser time zone): <span class="showLockTime"></span></h2>
<button class="withdraw"> Withdraw</button>


<script type="module">
    function blockchainTimestampToDateTime(blockchainTimestamp) {
        const date = new Date(blockchainTimestamp * 1000);

        const year = date.getFullYear();
        const month = ('0' + (date.getMonth() + 1)).slice(-2);
        const day = ('0' + date.getDate()).slice(-2);
        const hours = ('0' + date.getHours()).slice(-2);
        const minutes = ('0' + date.getMinutes()).slice(-2);
        const seconds = ('0' + date.getSeconds()).slice(-2);

        return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
    }

    async function getABI() {
        const response = await fetch('fltDropABI.json');
        const abi = await response.json();
        return abi;
    }

    import {ethers} from "https://cdnjs.cloudflare.com/ajax/libs/ethers/6.2.3/ethers.js";

    const connectEthereumButton = document.querySelector('.connect');
    const withFltButton = document.querySelector('.withdraw')
    const showAccount = document.querySelector('.showAccount');
    const showFltBalance = document.querySelector('.showFltBalance');
    const showLockTime = document.querySelector('.showLockTime');
    const fltDropAddress = '0x6081d7F04a8c31e929f25152d4ad37c83638C62b' // flt-drop Contract
    let lockedBalance = 0;
    const fltDropAbi = await getABI();
    console.log(`flt-drop合约地址: ${fltDropAddress}`)
    connectEthereumButton.addEventListener(`click`, connectOnClicker)
    withFltButton.addEventListener(`click`, withdrawOnClicker)
    const getChainId = async () => {
        const chainId = ethereum.networkVersion;
        if (chainId !== "1") {
            await window.ethereum
                .request({
                    method: "wallet_switchEthereumChain",
                    params: [
                        {
                            chainId: "0x1",
                        },
                    ],
                })
                .then(() => {
                    console.log("wallet_switchEthereumChain success");
                })
                .catch((e) => {
                    console.log("wallet_switchEthereumChain error: ", e);
                })
                .finally(() => {
                });
        }
    };


    async function connectOnClicker() {
        console.log("连接钱包")
        const provider = new ethers.BrowserProvider(window.ethereum)
        await getChainId();
        const accounts = await provider.send("eth_requestAccounts", []);
        const account = accounts[0]
        console.log(`钱包地址: ${account}`)
        showAccount.innerHTML = account;
        const contractFltDrop = new ethers.Contract(fltDropAddress, fltDropAbi, provider)
        const fltBalance = await contractFltDrop.balanceOf(account)
        console.log(`FLT余额: ${fltBalance}`)
        lockedBalance = fltBalance
        showFltBalance.innerHTML = ethers.formatEther(fltBalance.toString());
        let lockedBalances = await contractFltDrop.lockedBalances(account)
        console.log(`锁仓时间: ${lockedBalances.unlockTime}`)
        showLockTime.innerHTML = blockchainTimestampToDateTime(lockedBalances.unlockTime.toString());
    }

    async function withdrawOnClicker() {
        const provider = new ethers.BrowserProvider(window.ethereum)
        await getChainId();
        const accounts = await provider.send("eth_requestAccounts", []);
        const account = accounts[0];
        const signer = await provider.getSigner();
        const contractFltDrop = await new ethers.Contract(fltDropAddress, fltDropAbi, signer)
        console.log(`提取FLT: ${showFltBalance.innerHTML}`)
        if (lockedBalance === 0) {
            alert('There are no FLT tokens available for withdrawal, or you haven\'t clicked the \'connect\' button to fetch the data(没有可以提取flt或者没有点击connect按钮获取数据)')
            return
        }
        try {
            let tx = await contractFltDrop.transfer(account, lockedBalance)
            await tx.wait()
        } catch (e) {
            alert('Withdraw error（提取失败）: ' + e)
        }
    }
</script>
</body>
</html>