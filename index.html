<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
<h1 id="header">Connect to Metamask</h1>
<button class="connect"> Connect</button>
<h2>Wallet Address: <span class="showAccount"></span></h2>
<h2>Flt Balance: <span class="showFltBalance"></span></h2>
<h2>Lock Time (Based on the browser time zone): <span class="showLockTime"></span></h2>


<script type="module">
    function blockchainTimestampToDateTime(blockchainTimestamp) {
        const date = new Date(blockchainTimestamp * 1000);

        const year = date.getFullYear();
        const month = ('0' + (date.getMonth() + 1)).slice(-2);
        const day = ('0' + date.getDate()).slice(-2);
        const hours = ('0' + date.getHours()).slice(-2);
        const minutes = ('0' + date.getMinutes()).slice(-2);
        const seconds = ('0' + date.getSeconds()).slice(-2);

        return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
    }

    import {ethers} from "https://cdnjs.cloudflare.com/ajax/libs/ethers/6.2.3/ethers.js";

    const ethereumButton = document.querySelector('.connect');
    const showAccount = document.querySelector('.showAccount');
    const showFltBalance = document.querySelector('.showFltBalance');
    const showLockTime = document.querySelector('.showLockTime');
    let ALCHEMY_MAINNET_URL = '';
    await fetch('./config.json').then(response => response.json()).then(data => {
        ALCHEMY_MAINNET_URL = data.http_rpc
        console.log(`RPC地址: ${ALCHEMY_MAINNET_URL}`)
    })

    const fltDropAddress = '0x6081d7F04a8c31e929f25152d4ad37c83638C62b' // flt-drop Contract
    const provider = new ethers.JsonRpcProvider(ALCHEMY_MAINNET_URL);
    const fltDropAbi = [{
        "inputs": [{
            "internalType": "contract FluenceToken",
            "name": "_token",
            "type": "address"
        }, {"internalType": "contract Executor", "name": "_executor", "type": "address"}, {
            "internalType": "bytes32",
            "name": "_merkleRoot",
            "type": "bytes32"
        }, {"internalType": "uint256", "name": "_halvePeriod", "type": "uint256"}, {
            "internalType": "uint256",
            "name": "_lockupPeriod",
            "type": "uint256"
        }, {"internalType": "uint256", "name": "_initialReward", "type": "uint256"}, {
            "internalType": "uint256",
            "name": "_claimingPeriod",
            "type": "uint256"
        }, {"internalType": "address", "name": "_canceler", "type": "address"}, {
            "internalType": "uint256",
            "name": "_maxClaimedSupply",
            "type": "uint256"
        }], "stateMutability": "nonpayable", "type": "constructor"
    }, {
        "inputs": [{"internalType": "address", "name": "target", "type": "address"}],
        "name": "AddressEmptyCode",
        "type": "error"
    }, {
        "inputs": [{"internalType": "address", "name": "account", "type": "address"}],
        "name": "AddressInsufficientBalance",
        "type": "error"
    }, {"inputs": [], "name": "ECDSAInvalidSignature", "type": "error"}, {
        "inputs": [{
            "internalType": "uint256",
            "name": "length",
            "type": "uint256"
        }], "name": "ECDSAInvalidSignatureLength", "type": "error"
    }, {
        "inputs": [{"internalType": "bytes32", "name": "s", "type": "bytes32"}],
        "name": "ECDSAInvalidSignatureS",
        "type": "error"
    }, {"inputs": [], "name": "FailedInnerCall", "type": "error"}, {
        "inputs": [{
            "internalType": "address",
            "name": "token",
            "type": "address"
        }], "name": "SafeERC20FailedOperation", "type": "error"
    }, {
        "anonymous": false,
        "inputs": [{"indexed": true, "internalType": "uint256", "name": "userId", "type": "uint256"}, {
            "indexed": false,
            "internalType": "address",
            "name": "account",
            "type": "address"
        }, {"indexed": false, "internalType": "uint256", "name": "amount", "type": "uint256"}, {
            "indexed": false,
            "internalType": "bytes32",
            "name": "leaf",
            "type": "bytes32"
        }],
        "name": "Claimed",
        "type": "event"
    }, {
        "anonymous": false,
        "inputs": [{"indexed": true, "internalType": "address", "name": "from", "type": "address"}, {
            "indexed": true,
            "internalType": "address",
            "name": "to",
            "type": "address"
        }, {"indexed": false, "internalType": "uint256", "name": "value", "type": "uint256"}],
        "name": "Transfer",
        "type": "event"
    }, {
        "anonymous": false,
        "inputs": [{"indexed": false, "internalType": "uint256", "name": "amount", "type": "uint256"}],
        "name": "TransferUnclaimed",
        "type": "event"
    }, {
        "inputs": [{"internalType": "address", "name": "account", "type": "address"}],
        "name": "balanceOf",
        "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
        "stateMutability": "view",
        "type": "function"
    }, {
        "inputs": [],
        "name": "canceler",
        "outputs": [{"internalType": "address", "name": "", "type": "address"}],
        "stateMutability": "view",
        "type": "function"
    }, {
        "inputs": [{"internalType": "uint32", "name": "userId", "type": "uint32"}, {
            "internalType": "bytes32[]",
            "name": "merkleProof",
            "type": "bytes32[]"
        }, {"internalType": "address", "name": "temporaryAddress", "type": "address"}, {
            "internalType": "bytes",
            "name": "signature",
            "type": "bytes"
        }], "name": "claimTokens", "outputs": [], "stateMutability": "nonpayable", "type": "function"
    }, {
        "inputs": [],
        "name": "claimedSupply",
        "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
        "stateMutability": "view",
        "type": "function"
    }, {
        "inputs": [],
        "name": "claimingEndTime",
        "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
        "stateMutability": "view",
        "type": "function"
    }, {
        "inputs": [],
        "name": "currentReward",
        "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
        "stateMutability": "view",
        "type": "function"
    }, {
        "inputs": [],
        "name": "decimals",
        "outputs": [{"internalType": "uint8", "name": "", "type": "uint8"}],
        "stateMutability": "view",
        "type": "function"
    }, {
        "inputs": [],
        "name": "deployTime",
        "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
        "stateMutability": "view",
        "type": "function"
    }, {
        "inputs": [],
        "name": "executor",
        "outputs": [{"internalType": "contract Executor", "name": "", "type": "address"}],
        "stateMutability": "view",
        "type": "function"
    }, {
        "inputs": [],
        "name": "halvePeriod",
        "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
        "stateMutability": "view",
        "type": "function"
    }, {
        "inputs": [],
        "name": "initialReward",
        "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
        "stateMutability": "view",
        "type": "function"
    }, {
        "inputs": [{"internalType": "uint256", "name": "index", "type": "uint256"}],
        "name": "isClaimed",
        "outputs": [{"internalType": "bool", "name": "", "type": "bool"}],
        "stateMutability": "view",
        "type": "function"
    }, {
        "inputs": [],
        "name": "isClaimingActive",
        "outputs": [{"internalType": "bool", "name": "", "type": "bool"}],
        "stateMutability": "view",
        "type": "function"
    }, {
        "inputs": [{"internalType": "address", "name": "", "type": "address"}],
        "name": "lockedBalances",
        "outputs": [{"internalType": "uint256", "name": "amount", "type": "uint256"}, {
            "internalType": "uint256",
            "name": "unlockTime",
            "type": "uint256"
        }],
        "stateMutability": "view",
        "type": "function"
    }, {
        "inputs": [],
        "name": "lockupPeriod",
        "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
        "stateMutability": "view",
        "type": "function"
    }, {
        "inputs": [],
        "name": "maxClaimedSupply",
        "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
        "stateMutability": "view",
        "type": "function"
    }, {
        "inputs": [],
        "name": "merkleRoot",
        "outputs": [{"internalType": "bytes32", "name": "", "type": "bytes32"}],
        "stateMutability": "view",
        "type": "function"
    }, {
        "inputs": [],
        "name": "name",
        "outputs": [{"internalType": "string", "name": "", "type": "string"}],
        "stateMutability": "view",
        "type": "function"
    }, {
        "inputs": [],
        "name": "symbol",
        "outputs": [{"internalType": "string", "name": "", "type": "string"}],
        "stateMutability": "view",
        "type": "function"
    }, {
        "inputs": [],
        "name": "token",
        "outputs": [{"internalType": "contract FluenceToken", "name": "", "type": "address"}],
        "stateMutability": "view",
        "type": "function"
    }, {
        "inputs": [],
        "name": "totalSupply",
        "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
        "stateMutability": "view",
        "type": "function"
    }, {
        "inputs": [{"internalType": "address", "name": "to", "type": "address"}, {
            "internalType": "uint256",
            "name": "value",
            "type": "uint256"
        }],
        "name": "transfer",
        "outputs": [{"internalType": "bool", "name": "", "type": "bool"}],
        "stateMutability": "nonpayable",
        "type": "function"
    }, {"inputs": [], "name": "withdraw", "outputs": [], "stateMutability": "nonpayable", "type": "function"}]
    const contractFltDrop = new ethers.Contract(fltDropAddress, fltDropAbi, provider)
    console.log(`flt-drop合约地址: ${fltDropAddress}`)
    ethereumButton.addEventListener(`click`, onClickHandler)

    async function onClickHandler() {
        console.log("连接钱包")
        // 获得provider
        const provider = new ethers.BrowserProvider(window.ethereum)
        // 读取钱包地址
        const accounts = await provider.send("eth_requestAccounts", []);
        const account = accounts[0]
        console.log(`钱包地址: ${account}`)
        showAccount.innerHTML = account;
        // 读取FLT余额
        const fltBalance = await contractFltDrop.balanceOf(account)
        console.log(`FLT余额: ${fltBalance}`)
        showFltBalance.innerHTML = ethers.formatEther(fltBalance.toString());
        // 读取锁仓时间
        const lockedBalances = await contractFltDrop.lockedBalances(account)
        console.log(`锁仓时间: ${lockedBalances.unlockTime}`)
        showLockTime.innerHTML = blockchainTimestampToDateTime(lockedBalances.unlockTime.toString());
    }
</script>
</body>
</html>